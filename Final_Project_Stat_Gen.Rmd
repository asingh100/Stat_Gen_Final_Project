---
title: "Final Project"
output: pdf_document
---

```{r setup, include=FALSE}
library(TCGAbiolinks)
library(tidyverse)
library(SummarizedExperiment)
library(DescTools)
library(qqman)
```

## Introduction to Data and Background:

According to the Mayo Clinic, Renal Cell Carcinoma is the most common kidney cancer and the incidence of this cancer is increasing in the population [1](). One of the key risk factors attributed to the onset of Renal Cell Carcinoma is familial history of the disease or transmission through genetics [1](). Furthermore, there is evidence to show that kidney cancers begin when mutations form in some kidney cells' DNA which causes the cells to grow and divide very rapidly [1](). Some other studies have shown that DNA Methylation can play a role in gene expression which can in turn lead to complex diseases such as cancer[2](https://pubmed.ncbi.nlm.nih.gov/15542813/). This can specifically be seen for Renal Cell Carcinoma as well as a previous study done by Lasseigne et al showed that there is a difference in the methylation profiles between patients affected by Renal Cell Carcinoma and those that are not in several genes [3](https://pubmed.ncbi.nlm.nih.gov/25472429/). For this reason, in this analysis we will study the relationship between DNA Methylation and Renal Cell Carcinoma through the use of data gathered from the TCGA database. The data lists a set of 325 Cases and 160 Controls as well as their methylation levels. 160 of the Case samples are paired with the Control Samples meaning that the Control Sample for these 160 patients is a tissue sample that is adjacent to the tumor sample collected from the same patient. Furthermore, 165 of the Case samples are Independent samples. Studying the relationship between DNA Methylation and Renal Cell Carcinoma can help us create targeted therapies, help us to understand how this disease occurs, and help us uncover which CpG sites or regions in the genome are correlated with Renal Cell Carcinoma the most.

## Methods:

To analyze the relationship between DNA Methylation and Renal Cell Carcinoma we will first perform an analysis to find differentially methylated regions (DMR) between the two groups. To do this we will perform two sets of different t tests, stratifying by paired and unpaired samples. For the 160 paired Case/Control samples we will conduct a paired two sided t test for each CpG site in our data. For the other 165 Case Samples, we will conduct a two sample two sided t test comparing them with the 160 Control Samples for each CpG site in our data. Our null hypothesis for these tests is that there is no difference in methylation between cases and controls and our alternate hypothesis is that there is a significant difference in methylation between cases and controls. We will use the standard significance level of 0.05 to determine significance for both the paired and two sample t tests we are doing. We will be performing multiple comparison adjustments on this result as we are comparing hundreds of thousands of CpG sites so not adjusting for multiple comparisons could lead to large errors in our analysis. The method we will use to correct for multiple comparisons is FDR since this allows us to have a better power than when using other methods such as Bonferroni, especially since our sample size is extremely large. 

We will also perform a logistic regression analysis with disease status as the outcome variable and the methylation level as the predictor. This analysis will allow us to get a sense of the overall association between methylation and Renal Cell Carcinoma. Furthermore, using this method we can calculate the Odds Ratio as well as p-value for the association of Methylation and Disease status which are concrete metrics to assess association as a whole. For this analysis our null hypothesis is that there is no association between methylation and disease status and our alternate hypothesis is that there is an association between methylation and disease status.



## Data Download, Cleaning, and Processing:

```{r}
query_meth.hg19 <- GDCquery(project= "TCGA-KIRC",
                            data.category = "DNA methylation",
                            platform = "Illumina Human Methylation 450",
                            legacy = TRUE)
GDCdownload(query_meth.hg19)
data.hg19 <- GDCprepare(query_meth.hg19)

meth_data = data.frame(assay(data.hg19))

## Assessing Whether Samples are Paired or Not:
 patients = data.frame(Patient_ID = data.hg19$patient, Barcode = data.hg19$barcode)

sample = data.frame(data.hg19$sample_type,data.hg19$patient,data.hg19$barcode)

colnames(sample) = c("Group","Patient","Sample_ID")

sample$Group = recode(sample$Group, "Additional - New Primary" = "Primary Tumor")

Case = filter(sample, Group == "Primary Tumor")

Case$Sample_ID = gsub("-",".",Case$Sample_ID)

Control = filter(sample, Group == "Solid Tissue Normal")

Control$Sample_ID = gsub("-",".",Control$Sample_ID)

Case_Meth_Data = dplyr::select(meth_data,tidyselect::contains(Case$Sample_ID))

Control_Meth_Data = dplyr::select(meth_data,tidyselect::contains(Control$Sample_ID))

Case_Meth_Data = data.frame(t(Case_Meth_Data))

Control_Meth_Data = data.frame(t(Control_Meth_Data))

Case_Meth_Data = Case_Meth_Data[, colSums(is.na(Case_Meth_Data)) != nrow(Case_Meth_Data)]

Control_Meth_Data = Control_Meth_Data[, colSums(is.na(Control_Meth_Data)) != nrow(Control_Meth_Data)]

table(colnames(Case_Meth_Data)==colnames(Control_Meth_Data)) #check if CpG sites are same

# Add information about sample pairing to meth data:

Case_Meth_Data$Patient = Case$Patient

Control_Meth_Data$Patient = Control$Patient
```

## Two Sample and Paired T-Tests:

```{r}
#Two Sample T tests for Cases and Controls for Each CpG Site:

paired_t_test_res = data.frame()

t_test_res = data.frame()

Case_Idep_Meth_Data = filter(Case_Meth_Data,!Patient%in%Control_Meth_Data$Patient)

#Control_Idep_Meth_Data = filter(Control_Meth_Data,!Patient%in%Case_Meth_Data$Patient)

Case_Paired_Meth_Data = filter(Case_Meth_Data,Patient%in%Control_Meth_Data$Patient)

Control_Paired_Meth_Data = filter(Control_Meth_Data,Patient%in%Case_Meth_Data$Patient)

##Paired T Tests:

Case_Paired_Meth_Data = dplyr::select(Case_Paired_Meth_Data,-c(396066))


Control_Paired_Meth_Data = dplyr::select(Control_Paired_Meth_Data,-c(396066))


Paired_Combined_Meth_Data = rbind(Case_Paired_Meth_Data,Control_Paired_Meth_Data)

Paired_Combined_Meth_Data$Group = factor(c(rep("Case",160),rep("Control",160)))


for (j in seq(1,ncol(Case_Paired_Meth_Data))){
    paired_t_test_res_temp = t.test(Case_Paired_Meth_Data[[j]],Control_Paired_Meth_Data[[j]],alternative="two.sided",paired=T)$p.value
    paired_t_test_res = rbind(paired_t_test_res,paired_t_test_res_temp) 
}

paired_t_test_res$CpG_Site = colnames(Case_Paired_Meth_Data)

colnames(paired_t_test_res) = c("p.value","CpG_Site")

## FDR Correction:

paired_t_test_res_FDR = paired_t_test_res%>%
  mutate(FDR_P_Value = p.adjust(paired_t_test_res$p.value,method="fdr"))

##Two Sample T Tests:

for (j in seq(1,ncol(Case_Idep_Meth_Data)-1)){
    t_test_res_temp = t.test(Case_Idep_Meth_Data[[j]],Control_Meth_Data[[j]],alternative="two.sided")$p.value
    t_test_res = rbind(t_test_res,t_test_res_temp) 
}

t_test_res$CpG_Site = colnames(Case_Paired_Meth_Data)

colnames(t_test_res) = c("p.value","CpG_Site")

## FDR Correction:

t_test_res_FDR = t_test_res%>%
  mutate(FDR_P_Value = p.adjust(t_test_res$p.value,method="fdr"))
```

## Logistic Regression:

```{r}

```

## Results:

## Number of Methylation Sites with Significant Difference between Case and Controls:

```{r}

table(paired_t_test_res_FDR$FDR_P_Value<0.05)

table(t_test_res_FDR$FDR_P_Value<0.05)

```

## Manhattan Plot of FDR Corrected P-Values from Paired T Test:

```{r}
chrom_info = data.frame(rowRanges(data.hg19))%>%
  dplyr::select("seqnames","start","probeID")

t_test_FDR_w_chrom = merge(paired_t_test_res_FDR,chrom_info,by.x="CpG_Site",by.y="probeID")

colnames(t_test_FDR_w_chrom) = c("CpG_Site","p.value","FDR_P_Value",
                                 "chrom","pos")

t_test_FDR_w_chrom$FDR_P_Value = -log10(t_test_FDR_w_chrom$FDR_P_Value)

t_test_FDR_w_chrom$chrom = gsub("chr","",t_test_FDR_w_chrom$chrom)

t_test_FDR_w_chrom$chrom = recode(t_test_FDR_w_chrom$chrom,"X" = "23","Y"="24","NA"="25")

t_test_FDR_w_chrom$chrom = as.numeric(t_test_FDR_w_chrom$chrom)

plot <- t_test_FDR_w_chrom %>% 
  group_by(chrom) %>% 
  summarise(chr_len=max(pos)) %>% 
  mutate(tot=cumsum(as.numeric(chr_len))-chr_len) %>%
  dplyr::select(-chr_len) %>%
  left_join(t_test_FDR_w_chrom, ., by=c("chrom"="chrom")) %>%
  arrange(chrom,pos) %>%
  mutate(pos_cum=pos+tot)

axisdf = plot %>% group_by(chrom) %>% summarize(center=( max(pos_cum) + min(pos_cum) ) / 2 )

axisdf$chrom = c(seq(1,22),"X","Y","MT")

ggplot(plot, aes(x=pos_cum, y=FDR_P_Value)) +
    geom_point( aes(color=as.factor(chrom)), alpha=0.8, size=1.3) +
    scale_color_manual(values = rep(c("grey", "skyblue"),25))+
    scale_x_continuous( label = axisdf$chrom[seq(1, length(axisdf$chrom), by = 2)], breaks= axisdf$center[seq(1, length(axisdf$center), by = 2)] ) +
    scale_y_continuous(expand = c(0, 0) ) +
    theme_bw() +
    theme( 
      legend.position="none",
      panel.border = element_blank(),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank()
    )+
  xlab("Chromosome")+
  ylab("-log10(FDR Corrected P-value)")
```

From this manhattan plot of the paired t-test results we can see that 

## Manhattan Plot of FDR Corrected P-Values from Independent T Test:

```{r}

chrom_info = data.frame(rowRanges(data.hg19))%>%
  dplyr::select("seqnames","start","probeID")

t_test_FDR_w_chrom = merge(t_test_res_FDR,chrom_info,by.x="CpG_Site",by.y="probeID")

colnames(t_test_FDR_w_chrom) = c("CpG_Site","p.value","FDR_P_Value",
                                 "chrom","pos")

t_test_FDR_w_chrom$FDR_P_Value = -log10(t_test_FDR_w_chrom$FDR_P_Value)

t_test_FDR_w_chrom$chrom = gsub("chr","",t_test_FDR_w_chrom$chrom)

t_test_FDR_w_chrom$chrom = recode(t_test_FDR_w_chrom$chrom,"X" = "23","Y"="24","NA"="25")

t_test_FDR_w_chrom$chrom = as.numeric(t_test_FDR_w_chrom$chrom)

plot <- t_test_FDR_w_chrom %>% 
  group_by(chrom) %>% 
  summarise(chr_len=max(pos)) %>% 
  mutate(tot=cumsum(as.numeric(chr_len))-chr_len) %>%
  dplyr::select(-chr_len) %>%
  left_join(t_test_FDR_w_chrom, ., by=c("chrom"="chrom")) %>%
  arrange(chrom,pos) %>%
  mutate(pos_cum=pos+tot)

axisdf = plot %>% group_by(chrom) %>% summarize(center=( max(pos_cum) + min(pos_cum) ) / 2 )

axisdf$chrom = c(seq(1,22),"X","Y","MT")

ggplot(plot, aes(x=pos_cum, y=FDR_P_Value)) +
    geom_point( aes(color=as.factor(chrom)), alpha=0.8, size=1.3) +
    scale_color_manual(values = rep(c("grey", "skyblue"),25))+
    scale_x_continuous( label = axisdf$chrom[seq(1, length(axisdf$chrom), by = 2)], breaks= axisdf$center[seq(1, length(axisdf$center), by = 2)] ) +
    scale_y_continuous(expand = c(0, 0) ) +
    theme_bw() +
    theme( 
      legend.position="none",
      panel.border = element_blank(),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank()
    )+
  xlab("Chromosome")+
  ylab("-log10(FDR Corrected P-value)")
```

## Volcano Plot to pinpoint DMR's (Paired Samples):

```{r}
diff_mean_paired_Case = map_dfr(Case_Paired_Meth_Data,mean,na.rm=T)
diff_mean_paired_Control = map_dfr(Control_Paired_Meth_Data,mean,na.rm=T)
diff_mean_paired = diff_mean_paired_Case-diff_mean_paired_Control
diff_mean_paired = pivot_longer(diff_mean_paired,1:ncol(diff_mean_paired),values_to = "diff_mean", names_to = "CpG_Site")
diff_mean_paired = merge(diff_mean_paired,paired_t_test_res_FDR,by="CpG_Site")
diff_mean_paired$diffexpressed <- "Not Significant"
diff_mean_paired$diffexpressed[diff_mean_paired$diff_mean > 0.25 & diff_mean_paired$FDR_P_Value < 10^-5] <- "Hypermethylated"
diff_mean_paired$diffexpressed[diff_mean_paired$diff_mean < 0.25 & diff_mean_paired$FDR_P_Value < 10^-5] <- "Hypomethylated"
diff_mean_paired$diffexpressed[diff_mean_paired$diff_mean <= 0.25 & diff_mean_paired$diff_mean >= -0.25&diff_mean_paired$FDR_P_Value < 10^-5] <- "No Difference In Methylation"

ggplot(diff_mean_paired, aes(x=diff_mean, y=-log10(FDR_P_Value),col=diffexpressed)) +
    geom_point(alpha=0.8, size=1.3)+
    theme_bw() +
  scale_color_manual(values=c("black", "blue", "pink","red"))+
    theme(legend.position="top")+
  guides(fill=guide_legend(title="Methylation (Case vs Controls)"))+
  geom_hline(yintercept = 5, color = "darkblue")+
  geom_vline(xintercept = 0.25,color="darkred")+
  geom_vline(xintercept = -0.25,color="darkred")+
  xlab("Difference in Mean Methylation between Case and Controls")+
  ylab("-log10(FDR Corrected P-value)")+
  ggtitle("Volcano Plot showing DMR's for Paired Case/Control Samples")
```

## Volcano Plot to pinpoint DMR's (Independent Samples):

```{r}
diff_mean_Idep_Case = map_dfr(Case_Idep_Meth_Data[,-ncol(Case_Idep_Meth_Data)],mean,na.rm=T)
diff_mean_Idep_Control = map_dfr(Control_Meth_Data[,-ncol(Case_Idep_Meth_Data)],mean,na.rm=T)
diff_mean_Idep = diff_mean_Idep_Case-diff_mean_Idep_Control
diff_mean_Idep = pivot_longer(diff_mean_Idep,1:ncol(diff_mean_Idep),values_to = "diff_mean", names_to = "CpG_Site")
diff_mean_Idep = merge(diff_mean_Idep,t_test_res_FDR,by="CpG_Site")
diff_mean_Idep$diffexpressed <- "Not Significant"
diff_mean_Idep$diffexpressed[diff_mean_Idep$diff_mean > 0.25 & diff_mean_Idep$FDR_P_Value < 10^-5] <- "Hypermethylated"
diff_mean_Idep$diffexpressed[diff_mean_Idep$diff_mean < 0.25 & diff_mean_Idep$FDR_P_Value < 10^-5] <- "Hypomethylated"
diff_mean_Idep$diffexpressed[diff_mean_Idep$diff_mean <= 0.25 & diff_mean_Idep$diff_mean >= -0.25&diff_mean_Idep$FDR_P_Value < 10^-5] <- "No Difference In Methylation"

ggplot(diff_mean_Idep, aes(x=diff_mean, y=-log10(FDR_P_Value),col=diffexpressed)) +
    geom_point(alpha=0.8, size=1.3)+
    theme_bw() +
  scale_color_manual(values=c("black", "blue", "pink","red"))+
    theme(legend.position="top")+
  guides(fill=guide_legend(title="Methylation (Case vs Controls)"))+
  geom_hline(yintercept = 5, color = "darkblue")+
  geom_vline(xintercept = 0.25,color="darkred")+
  geom_vline(xintercept = -0.25,color="darkred")+
  xlab("Difference in Mean Methylation between Case and Controls")+
  ylab("-log10(FDR Corrected P-value)")+
  ggtitle("Volcano Plot showing DMR's for Independent Case/Control Samples")
```

## Discussion and Conclusions:
